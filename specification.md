# 💻 ブラウザ試作用実装仕様書：ひよこのねじあつめ

## 1. プロジェクト概要

- **目的**: レトロゲームボーイ風のビジュアルを持つ、スネーク型アクションパズルゲームのブラウザ上でのプロトタイプ実装。
- **ターゲット環境**: HTML5, JavaScript (ES6+), Canvas API
- **ネイティブ解像度**: 160 $\times$ 144 ピクセル
- **単位**: 全て**8 $\times$ 8 ピクセル**のグリッド単位で処理。

## 2. 画面設計

ゲームには、主に以下の3つの画面が存在する。

1.  **タイトル画面**:

    - **背景**: `resources/title.png` (160x144) を全画面に表示する。
    - **テキスト**:
      - 画面下部に、ビットマップフォントを用いて以下の文字列を中央揃えで表示する。
      - `PRESS START` (Y座標: 126px)　一定間隔で点滅させる。
      - `(C) 2025 5z6p.com` (Y座標: 135px)
      - 文字色は `#0f380f` (最も暗い色) を使用する。

2.  **ゲーム画面**:
    ゲームプレイ中の画面。上部の「ステータスエリア」と、その下の「ゲームエリア」の2つに分割される。

    - **2.1. ステータスエリア**:

      - **領域**: 画面上部の 160 $\times$ 16 ピクセル (20 $\times$ 2 グリッド分)。
      - **表示内容**:
        - **スコア**: 左側に `SCORE:[現在のスコア]` をビットマップフォントで表示。
        - **経過時間**: 右側に `TIME:[分:秒]` をビットマップフォントで表示。

    - **2.2. ゲームエリア**:
      - **領域**: ステータスエリアを除く 160 $\times$ 128 ピクセル (20 $\times$ 16 グリッド分)。
      - **特徴**: このエリアが `gameMap` の描画範囲となる。マップの最も外側のグリッドは壁(`'W'`)で囲むこと。

3.  **ゲームオーバー画面**:
    - **背景**: ゲーム画面の上に、半透明のオーバーレイ (`#0f380f` のアルファ値 `0.7`) を重ねて表示する。
    - **表示内容**:
      - 画面中央のボックス内に、以下の要素を中央揃えで表示する。
      - `resources/game_over.png` 画像を表示する。
      - `SCORE [スコア]` をビットマップフォントで表示する。
      - `RETURN TO TITLE` をビットマップフォントで表示する。
      - 文字色は `#0f380f`を使用する。
      - 文字枠は`#0f380f`で、背景色は`#8bac0f`を使用する。

## 3. 定数と調整可能パラメータ

以下の定数を`game.js`の冒頭で定義し、ゲームバランスの調整に用いること。

| 定数名                     | 値             | 単位/説明                                                  |
| :------------------------- | :------------- | :--------------------------------------------------------- |
| `NATIVE_WIDTH`             | 160            | 描画キャンバスの幅                                         |
| `NATIVE_HEIGHT`            | 144            | 描画キャンバスの高さ                                       |
| `GRID_SIZE`                | 8              | 1グリッド（タイル）のサイズ (px)                           |
| `FPS_TARGET`               | 60             | フレームレート                                             |
| `BASE_SPEED_GPS`           | 2              | 基本速度 (グリッド/秒)。                                   |
| `INITIAL_SPEED_MULTIPLIER` | 1.0            | 初期速度係数                                               |
| `SPEED_INCREASE_PICKUP`    | 0.2 (調整推奨) | ねじ収集時の速度係数増加量 ($\Delta K_{pickup}$)           |
| `SPEED_INCREASE_DELIVERY`  | 0.6 (調整推奨) | 空振りデリバリー時の速度係数増加量 ($\Delta K_{delivery}$) |
| `SPEED_DECREASE_DELIVERY`  | 0.6 (調整推奨) | デリバリー成功時の速度係数減少率                           |

## 4. ゲーム状態 (`gameState`オブジェクト)

ゲームの状態を管理する単一のオブジェクトを定義する。

| プロパティ        | 型                                   | 説明                                             |
| :---------------- | :----------------------------------- | :----------------------------------------------- |
| `chickPos`        | `{x: number, y: number}`             | ひよこの現在のグリッド座標                       |
| `chickDirection`  | `string`                             | 現在の進行方向 ('UP', 'DOWN', 'LEFT', 'RIGHT')   |
| `moveFrameTimer`  | `number`                             | 次の移動までのフレーム数をカウントするタイマー   |
| `body`            | `Array<{type: string, pos: {x, y}}>` | 連結されたねじの列（キュー構造として扱う）       |
| `speedMultiplier` | `number`                             | 現在の速度係数 ($K$)。初期値 `1.0`               |
| `score`           | `number`                             | 現在のスコア                                     |
| `elapsedTime`     | `number`                             | 経過時間 (秒)                                    |
| `isGameOver`      | `boolean`                            | ゲームオーバーフラグ                             |
| `inputQueue`      | `Array<string>`                      | キー入力を格納するキュー ('UP', 'DOWN'など)      |
| `gameMap`         | `Array<Array<string>>`               | 壁、アイテム、箱の配置データ (**20x16**グリッド) |

## 5. コアロジックの実装要件

### 5.1. ゲームループと描画

- `requestAnimationFrame` を利用して、**60 FPS**をターゲットとしたゲームループを実装する。
- **描画**: Canvas APIを使用し、全ての描画は定義されたカラーパレットとスプライトシートに沿って行う。

#### 5.1.1. カラーパレットと配色

ゲームボーイ風のビジュアルを再現するため、描画はすべて以下の4階調カラーパレットで行う。

| 色 (16進数) | 明るさの順     |
| :---------- | :------------- |
| `#9bbc0f`   | 1 (最も明るい) |
| `#8bac0f`   | 2              |
| `#306230`   | 3              |
| `#0f380f`   | 4 (最も暗い)   |

- **ゲーム内で使用する色はこの4色のみとする。**
- **背景色**: `#9bbc0f` (最も明るい色)
- **UI文字色**: `#0f380f` (最も暗い色)
- **スプライト**: `hiyoko.png` 内のスプライトは、これら4色のみを使用して描画されている。

#### 5.1.2. スプライト

- 全てのスプライトは **8x8 ピクセル**。
- アルファチャンネル付きPNG形式の単一ファイル `hiyoko.png` に横一列で格納されている。
- ゲーム描画時には、このスプライトシートから対応するグラフィックを切り出して使用する。

#### 5.1.3. スプライトシートの構成 (`hiyoko.png`)

スプライトは左から以下の順で並んでいる。

| インデックス | スプライト名            | 説明                   |
| :----------- | :---------------------- | :--------------------- |
| 0            | ひよこ前向き            | 下方向への移動時に使用 |
| 1            | ひよこ左向き            | 左方向への移動時に使用 |
| 2            | ひよこ右向き            | 右方向への移動時に使用 |
| 3            | ひよこ後ろ向き          | 上方向への移動時に使用 |
| 4            | 落ちているねじ1         |                        |
| 5            | 落ちているねじ2         |                        |
| 6            | ひよこの後ろにあるねじ1 | 連結された状態         |
| 7            | ひよこの後ろにあるねじ2 | 連結された状態         |
| 8            | ねじ1用の箱             |                        |
| 9            | ねじ2用の箱             |                        |
| 10           | 壁                      |                        |

#### 5.1.4. UI

- 全てのテキストは、後述するビットマップフォントを用いて描画する。
- フォントの色は、ゲーム読み込み時にUI文字色 (`#0f380f`) に動的に着色される。

#### 5.1.5. ビットマップフォント

- **ソースファイル**: `resources/font.png`
- **構成**:
  - フォント画像は、透明と黒の2色で構成されている。
  - ゲーム起動時に、画像の黒い部分がUI文字色 (`#0f380f`) に着色され、新しいフォント画像としてメモリ上に保持される。
- **基本サイズ**:
  - スプライトシート上では、全ての文字は **幅5px, 高さ8px** で格納されている。
- **描画仕様**:
  - **文字間隔**: 文字間隔はスプライトに含まれているので**0px**。
  - **可変幅**:
    - 文字 `'T'` と `'W'` は、描画時に文字の後ろにさらに **1px** の追加スペースが確保される（実質的な占有幅は `5px + 1px + 1px = 7px` となる）。
    - 文字 `'I'`は余白を含めて5pxで格納されているので、前方1px分を省略して表示する。

### 5.1.1. マップタイル定義

`gameMap` 配列で使用する文字列とオブジェクトの対応は以下の通り。

| 文字列 | 意味                |
| :----- | :------------------ |
| `' '`  | 空白                |
| `'W'`  | 壁 (Wall)           |
| `'N1'` | ねじ1 (Screw 1)     |
| `'N2'` | ねじ2 (Screw 2)     |
| `'B1'` | ねじ1用の箱 (Box 1) |
| `'B2'` | ねじ2用の箱 (Box 2) |

### 5.2. 移動と操作 (`update()` 関数内)

ゲームの更新はフレームごとに行われるが、ひよこの**移動は一定フレーム間隔**で行う。

1.  **時間経過**: ゲームプレイ中 (`PLAYING`) のみ、`elapsedTime` をフレーム時間分だけ加算する。タイトル画面 (`TITLE`) およびゲームオーバー画面 (`GAME_OVER`) では時間は停止する。
2.  **移動タイミングの判定**:
    - `update`関数が呼ばれるたびに`moveFrameTimer`を1ずつデクリメントする。
    - `moveFrameTimer`が0以下になった時、以下の移動処理を実行する。
3.  **移動処理**:
    - **方向転換**:
      - `inputQueue`の先頭に有効な入力（現在の進行方向と逆ではない）があれば、それを取り出して`chickDirection`を更新する。
    - **座標更新**:
      - `chickDirection`に従い、`chickPos`の座標を1グリッド分更新する。
    - **連結体の追従**:
      - `body`の各パーツ（ねじ）の位置を、1つ前のパーツがいたグリッド位置に更新していくことで、ひよこに追従させる。
    - **タイマーリセット**:
      - 次の移動までの待機フレーム数を `waitFrames = floor(FPS_TARGET / (BASE_SPEED_GPS * speedMultiplier))` で計算する。
      - `moveFrameTimer`を`waitFrames`の値にリセットする。
4.  **描画**:
    - ひよこと`body`は、`chickPos`および`body`の各`pos`に基づいて、グリッド上に再描画される。移動のたびに描画が更新されるため、カクカクとした動きになる。

### 5.3. 速度管理

`speedMultiplier`は、ひよこの移動速度を決定する係数。この値が大きくなるほど、移動間隔フレーム数 (`waitFrames`) が短くなり、結果的にひよこの移動が速くなる。

以下のイベント発生時、`speedMultiplier`に所定の値を加算する。

1.  **ねじ収集成功時**: `speedMultiplier += SPEED_INCREASE_PICKUP`
2.  **デリバリー成功時**: `speedMultiplier += SPEED_INCREASE_DELIVERY`

### 5.4. 衝突・イベント判定 (`checkEvents()` 関数内)

判定は、ひよこが移動後のグリッド座標 (`nextGridPos`) に対して行う。

| 対象                     | 判定ロジック                                  | 結果                                           |
| :----------------------- | :-------------------------------------------- | :--------------------------------------------- |
| **壁 / 自損**            | `nextGridPos`が壁または自身の胴体の位置と一致 | **ゲームオーバー** (GO)                        |
| **ねじアイテム (1/2)**   | `nextGridPos`にねじアイテムが存在             | 収集処理を実行。ねじを`body`の**末尾**に追加。 |
| **ねじ入れ物 (Box 1/2)** | `nextGridPos`に入れ物 (Box) が存在            | **デリバリー判定**を実行。                     |

### 5.4.1. ねじの自動生成

ねじアイテムを収集すると、以下のルールで新しいねじがマップ上に1つ自動で生成される。

- **トリガー**: ひよこが `ねじアイテム (1/2)` を収集した直後。
- **種類**: 新しく生成されるねじの種類（1または2）はランダムに決定される。このとき、盤上に必ずどちらのネジも存在し続けるように選択される。ひよこが運んでいるネジは含まない。
- **場所**: マップ上の壁、箱、ひよこ自身、連結されたねじ以外の、完全に空いているマスの中からランダムに1マス選ばれて配置される。

### 5.5. デリバリーロジック（厳格）

デリバリー判定は、ひよこが箱に接触した際の `body` の状態によって、以下の通り分岐する。

1.  **成功**:

    - **条件**: `body` が空ではなく、**先頭**にあるねじの種類が接触した入れ物の種類と一致する。
    - **処理**:
      - **コンボ判定**: `body`の先頭から、同じ種類のねじがいくつ連続しているかを数える（コンボ数）。
      - `body`の先頭からコンボ数ぶんの要素を削除する。
      - **連結体の更新**: `body`の先頭からコンボ数ぶんの要素を削除する。残ったねじは、削除されたねじが元々あった位置に詰めるように、それぞれの座標を前方にシフトさせる。
      - **スコア加算**: 判定したコンボ数に基づきスコアを加算する (詳細は `5.7. スコアリング` を参照)。
      - **速度減少**: `speedMultiplier`を減少させる。基準となる速度は、前回デリバリーが成功した後の速度とする（初回デリバリーの場合はゲーム開始時の初期速度を基準とする）。この基準速度からの増加分に対して `SPEED_DECREASE_DELIVERY` をかけて、速度を減少させる。
      - **箱の再配置**: 使用された箱をマップから削除し、同じ種類の箱をランダムな空きマスに再配置する。

2.  **失敗 (種類不一致)**:

    - **条件**: `body`の**先頭**にあるねじの種類が、接触した入れ物の種類と**不一致**である。
    - **処理**: **ゲームオーバー**とする。

3.  **空振り (アイテムなし)**:
    - **条件**: `body` が空の状態で箱に接触した。
    - **処理**:
      - **ゲームオーバーにはしない**。
      - **速度上昇**: `speedMultiplier` に `SPEED_INCREASE_DELIVERY` を加算する。
      - スコアの加算や箱の再配置は行わない。

### 5.6. 入力処理

キーボードイベント (`keydown`) をリッスンし、現在のゲームシーン (`currentScene`) に応じて処理を行う。タッチ操作については「9. ブラウザでの表示」の項で別途定義する。

### 5.7. スコアリング

スコアは以下のルールに従って加算される。

- **スコアの発生源**: スコアは、ひよこが「ねじ入れ物(Box)」に正常にねじを届けた（デリバリー成功）場合にのみ発生する。ねじを拾うだけではスコアは加算されない。
- **スコア計算**:
  - 一度にデリバリーした**同じ色の連続したねじの個数**を `n` とする。
  - 加算されるスコアは、この `n` を用いて `n * (n + 1) / 2` という式で計算される。
  - 具体例:
    - 連続1個: 1点
    - 連続2個: 3点 (1+2)
    - 連続3個: 6点 (1+2+3)
    - 連続4個: 10点 (1+2+3+4)

## 6. ゲームオーバー条件

以下のいずれかの条件が満たされた場合、`isGameOver = true`とし、ゲームを即座に停止する。

1.  フィールドの壁または障害物に衝突。
2.  自身の胴体（ねじの列）に衝突（自損）。
3.  **直後のねじと種類が異なる入れ物に接触した場合（デリバリー失敗）**。

## 7. 初期化処理 (`init()` 関数)

ゲーム開始時またはリスタート時に、以下の初期化処理を行う。

- **ひよこ**: `chickPos = {x: 10, y: 9}` (グリッド中央付近), `chickDirection = 'UP'`, `moveFrameTimer = 0`
- **スコア**: `score = 0`
- **経過時間**: `elapsedTime = 0`
- **速度**: `speedMultiplier = 1.0`
- **ゲーム状態**: `isGameOver = false`
- **マップ**: `gameMap` を初期レイアウトで生成する。壁、アイテム、箱を配置する。
- **アイテム**:
  - **ねじ**: 合計3個配置される。このとき、必ず全ての種類のネジが配置される。
  - **箱**: 箱が種類ごとに1個づつ配置される。

## 8. サウンド

ゲームには以下のイベントでサウンドエフェクトを再生する。サウンドファイルは `resources` ディレクトリに配置される。

| イベント                 | ファイル名 (例)                    | 発生条件                                                                 |
| :----------------------- | :--------------------------------- | :----------------------------------------------------------------------- |
| ゲームスタート時         | `resources/game_start.wav`         | ゲームが開始された際に再生                                               |
| アイテム収集時           | `resources/item_pickup.wav`        | ひよこがねじアイテムを拾った際に再生                                     |
| アイテムデリバリー成功時 | `resources/item_delivery.wav`      | ひよこがねじアイテムを箱に入れた際に再生。コンボ数に応じて繰り返し再生。 |
| アイテムデリバリー失敗時 | `resources/item_delivery_fail.wav` | ひよこがアイテムを持たずに箱に接触した際に再生。                         |
| ゲームオーバー時         | `resources/game_over.wav`          | ゲームオーバーになった際に再生                                           |

## 9. ブラウザでの表示

- **目的**: ゲームの実行環境としてブラウザを使用する際の表示方法を定義する。
- **全体レイアウト**:
  - ゲーム全体をゲームボーイ本体風の枠（筐体）で囲む。
  - 筐体の中に、ゲーム画面とUIコントロールを内包する「スクリーンエリア」を設ける。
- **筐体 (`#game-container`)**:
  - 背景色をグレーにし、角丸とシャドウで立体感を表現する。
- **スクリーンエリア (`#screen-area`)**:
  - ゲームの最も暗い色を背景とし、画面が埋め込まれているようなデザインにする。
- **ゲーム画面 (`canvas`)**:
  - ネイティブ解像度 (160x144) のキャンバスを作成する。
- **拡大表示**:
  - CSSを使用して筐体全体を整数倍に拡大して表示する。
  - 拡大時にドット絵がぼやけないように、CSSで `image-rendering: pixelated;` を適用する。
- **配置**: 拡大された筐体は、ブラウザウィンドウの中央に配置する。

### 9.1. スマートフォン対応 (タッチUI)

スマートフォンでの操作を可能にするため、タッチUIを実装する。この機能はゲームのコアロジックとは分離して実装する。

- **UI要素の実装**:
  - ゲーム描画用のキャンバス(`160x144`)の直下に、UI操作用のHTML要素を配置するコンテナ(`div`)を設ける。
  - コンテナ内に、十字キーとスタートボタンをHTML要素(`div`や`button`)で構成する。
- **スタイリング**:
  - UI要素の見た目（形状、色、配置）はすべて外部CSSファイル (`style.css`) で定義する。
  - **レイアウト**: 十字キーはUIエリアの中央に配置し、スタートボタンは十字キーと重ならないように右下に小さく配置する。
  - **デザイン**: UIエリアの背景とボタン類の色を、ゲームボーイ本体の筐体や物理ボタンを模した配色にする。ボタン押下時の色の変化は、CSSの`:active`擬似クラスを用いて実装し、視覚的なフィードバックを与える。
- **入力処理**:
  - 各UIボタン要素に`mousedown`および`touchstart`イベントリスナーを設定する。
  - ボタンが押された場合、既存のキーボード入力処理(`handleKeyDown`)を擬似的なキーイベントで呼び出すことで、入力処理ロジックを一元化する。
    - **十字キー**: `ArrowUp`, `ArrowDown`, `ArrowLeft`, `ArrowRight` に相当するイベントを発生させる。
    - **スタートボタン**: `Space` に相当するイベントを発生させる。
